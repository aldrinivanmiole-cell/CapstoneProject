<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>{% block title %}{{ SITE_TITLE or 'Classroom' }}{% endblock %}</title>
  <!-- Bootstrap 5 CSS CDN -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Google Fonts: Roboto -->
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
  <!-- Google Material Icons -->
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <!-- AOS Animation Library -->
  <link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet">
  <style>
    :root {
      --brand-color: {{ BRAND_COLOR or '#667eea' }};
    }
    body {
      font-family: 'Roboto', sans-serif;
      background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
      margin: 0;
      transition: all 0.3s ease;
    }

    .sidebar-custom {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      width: 280px;
      height: 100vh;
      position: fixed;
      top: 0;
      left: 0;
      padding: 16px 0;
      border-right: 1px solid rgba(224, 224, 224, 0.3);
      overflow-y: auto;
      z-index: 1000;
      box-shadow: 2px 0 10px rgba(0,0,0,0.1);
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .main-content-custom {
      margin-left: 280px;
      min-height: 100vh;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .main-content-custom.logged-out {
      margin-left: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
    }

    .auth-card {
      width: 100%;
      max-width: 420px;
      padding: 32px;
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(15px);
      border-radius: 16px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.1);
      border: 1px solid rgba(255, 255, 255, 0.2);
      animation: slideUp 0.6s ease;
    }

    @keyframes slideUp {
      from {
        opacity: 0;
        transform: translateY(30px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .flash-messages {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 1050;
      max-width: 450px;
      min-width: 300px;
    }

    .flash-messages .alert {
      margin-bottom: 10px;
      box-shadow: 0 8px 25px rgba(0,0,0,0.15);
      word-wrap: break-word;
      white-space: normal;
      border: none;
      backdrop-filter: blur(10px);
      animation: slideInRight 0.5s ease;
    }

    @keyframes slideInRight {
      from {
        opacity: 0;
        transform: translateX(100px);
      }
      to {
        opacity: 1;
        transform: translateX(0);
      }
    }

    .card {
      border: none;
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.08);
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      background: rgba(255, 255, 255, 0.9);
      backdrop-filter: blur(10px);
    }

    .card:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 30px rgba(0,0,0,0.12);
    }

    .btn {
      border-radius: 8px;
      font-weight: 500;
      transition: all 0.2s ease;
      border: none;
    }

    .btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }

    .btn-primary { background: var(--brand-color); }

    .btn-success {
      background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
    }

    .btn-warning {
      background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
    }

    .sidebar-nav-item {
      margin: 4px 16px;
      border-radius: 12px;
      transition: all 0.2s ease;
      position: relative;
      overflow: hidden;
    }

    .sidebar-nav-item::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
      transition: left 0.5s;
    }

    .sidebar-nav-item:hover::before {
      left: 100%;
    }

    .sidebar-nav-item.active {
      background: linear-gradient(135deg, #e3f2fd 0%, #f3e5f5 100%);
      color: #1976d2;
      transform: translateX(4px);
    }

    .sidebar-nav-item:hover {
      background: rgba(245, 245, 245, 0.8);
      transform: translateX(2px);
    }

    .progress {
      border-radius: 10px;
      background: rgba(0,0,0,0.1);
    }

    .progress-bar {
      border-radius: 10px;
      background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
    }

    .badge {
      border-radius: 6px;
      font-weight: 500;
    }

    @media (max-width: 768px) {
      .sidebar-custom {
        transform: translateX(-280px);
        transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      }
      .sidebar-custom.show {
        transform: translateX(0);
      }
      .main-content-custom {
        margin-left: 0;
      }
      .mobile-menu-btn {
        display: block !important;
      }
      .flash-messages {
        left: 20px;
        right: 20px;
        max-width: none;
        min-width: auto;
        top: 10px;
      }
    }

    .mobile-menu-btn {
      display: none;
      position: fixed;
      top: 16px;
      left: 16px;
      z-index: 1001;
      background: rgba(255, 255, 255, 0.9);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(224, 224, 224, 0.3);
      border-radius: 50%;
      width: 48px;
      height: 48px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      transition: all 0.2s ease;
    }

    .mobile-menu-btn:hover {
      transform: scale(1.05);
      box-shadow: 0 6px 20px rgba(0,0,0,0.2);
    }

    .sidebar-header {
      padding: 16px 24px;
      border-bottom: 1px solid rgba(224, 224, 224, 0.3);
      margin-bottom: 16px;
    }

    .loading-spinner {
      display: none;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      z-index: 9999;
    }

    .overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      z-index: 9998;
      backdrop-filter: blur(5px);
    }
  </style>
  {% block extra_styles %}{% endblock %}
</head>
<body>
  <!-- Flash Messages - Fixed Position -->
  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      <div class="flash-messages">
        {% for category, message in messages %}
          <div class="alert alert-{{ 'success' if category == 'success' else 'danger' }} alert-dismissible fade show" role="alert">
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
          </div>
        {% endfor %}
      </div>
    {% endif %}
  {% endwith %}

  {% set is_admin = session.get('admin_id') %}
  {% if session.get('teacher_id') and not is_admin %}
    <button class="btn mobile-menu-btn" onclick="toggleSidebar()">
      <i class="material-icons">menu</i>
    </button>
    
    <nav class="sidebar-custom" id="sidebar">
      <div class="sidebar-header">
        <div class="d-flex align-items-center">
          <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%234285f4'%3E%3Cpath d='M12 2l3.09 6.26L22 9l-5 4.87L18.18 22 12 18.77 5.82 22 7 13.87 2 9l6.91-.74L12 2z'/%3E%3C/svg%3E" width="28" height="28" alt="Classroom" class="me-2">
          <h5 class="mb-0 fw-normal">Classroom</h5>
        </div>
      </div>
      
      <div class="px-3">
        <a href="{{ url_for('index') }}" class="btn w-100 text-start d-flex align-items-center py-3 sidebar-nav-item {% if request.endpoint=='index' %}active{% endif %}">
          <i class="material-icons me-3">home</i>
          <span>Home</span>
        </a>
        
        <div class="mt-4 pt-3 border-top">
          <a href="{{ url_for('create_class') }}" class="btn w-100 text-start d-flex align-items-center py-2 sidebar-nav-item">
            <i class="material-icons me-3">add</i>
            <span>Create Class</span>
          </a>
          <a href="{{ url_for('archived_classes') }}" class="btn w-100 text-start d-flex align-items-center py-2 sidebar-nav-item">
            <i class="material-icons me-3">archive</i>
            <span>Archived Classes{% if archived_count is defined and archived_count %} ({{ archived_count }}){% endif %}</span>
          </a>
          <a href="{{ url_for('logout') }}" class="btn w-100 text-start d-flex align-items-center py-2 sidebar-nav-item">
            <i class="material-icons me-3">logout</i>
            <span>Sign out</span>
          </a>
        </div>
      </div>
    </nav>
  {% endif %}
  
  {% if is_admin %}
  <nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm" style="position: sticky; top: 0; z-index: 1000;">
    <div class="container-fluid">
      <a class="navbar-brand" href="{{ url_for('admin_dashboard') }}">{{ SITE_TITLE or 'Admin' }}</a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#adminNav" aria-controls="adminNav" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="adminNav">
        <ul class="navbar-nav me-auto mb-2 mb-lg-0">
          <li class="nav-item"><a class="nav-link" href="{{ url_for('admin_teachers') }}">Teachers</a></li>
          <li class="nav-item"><a class="nav-link" href="{{ url_for('admin_students') }}">Students</a></li>
          <li class="nav-item"><a class="nav-link" href="{{ url_for('admin_classes') }}">Classes</a></li>
          <li class="nav-item"><a class="nav-link" href="{{ url_for('admin_enrollments') }}">Enrollments</a></li>
        </ul>
        <div class="d-flex">
          <a class="btn btn-outline-secondary btn-sm" href="{{ url_for('admin_logout') }}">Logout</a>
        </div>
      </div>
    </div>
  </nav>
  {% endif %}

  <main class="main-content-custom {% if session.get('teacher_id') or is_admin %}logged-in{% else %}logged-out{% endif %}">
    {% set is_auth_page = (not session.get('teacher_id')) and (request.endpoint == 'login' or request.endpoint == 'register') %}
    {% if is_auth_page %}
      <div class="auth-card">
    {% endif %}
    {% block content %}{% endblock %}
    {% if is_auth_page %}
      </div>
    {% endif %}
  </main>
  
  <!-- Bootstrap 5 JS CDN -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <!-- AOS Animation Library -->
  <script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>
  
  <!-- Loading Spinner -->
  <div class="overlay" id="loadingOverlay"></div>
  <div class="loading-spinner" id="loadingSpinner">
    <div class="spinner-border text-primary" role="status">
      <span class="visually-hidden">Loading...</span>
    </div>
  </div>

  <script>
    // Initialize AOS animations
    AOS.init({
      duration: 800,
      easing: 'ease-out-cubic',
      once: true,
      offset: 50
    });

    // Enhanced sidebar toggle with smooth animation
    function toggleSidebar() {
      const sidebar = document.getElementById('sidebar');
      const overlay = document.getElementById('loadingOverlay');
      
      if (sidebar) {
        sidebar.classList.toggle('show');
        
        // Add backdrop for mobile
        if (window.innerWidth <= 768) {
          if (sidebar.classList.contains('show')) {
            overlay.style.display = 'block';
            overlay.style.opacity = '0.5';
          } else {
            overlay.style.opacity = '0';
            setTimeout(() => overlay.style.display = 'none', 300);
          }
        }
      }
    }

    // Close sidebar when clicking overlay
    document.getElementById('loadingOverlay').addEventListener('click', function() {
      if (window.innerWidth <= 768) {
        toggleSidebar();
      }
    });

    // Auto-dismiss flash messages with smooth animation
    document.addEventListener('DOMContentLoaded', function() {
      const alerts = document.querySelectorAll('.flash-messages .alert');
      alerts.forEach(function(alert, index) {
        // Stagger the auto-dismiss timing
        setTimeout(function() {
          alert.style.animation = 'slideOutRight 0.5s ease forwards';
          setTimeout(function() {
            if (alert.parentNode) {
              alert.remove();
            }
          }, 500);
        }, 5000 + (index * 500));
      });

      // Add smooth loading animation for page transitions
      const links = document.querySelectorAll('a:not([target="_blank"]):not([href^="#"]):not([data-bs-toggle])');
      links.forEach(link => {
        link.addEventListener('click', function(e) {
          if (this.href && !this.href.includes('javascript:')) {
            showLoadingSpinner();
          }
        });
      });

      // Add hover effects to cards
      const cards = document.querySelectorAll('.card');
      cards.forEach(card => {
        card.addEventListener('mouseenter', function() {
          this.style.transform = 'translateY(-4px) scale(1.02)';
        });
        
        card.addEventListener('mouseleave', function() {
          this.style.transform = 'translateY(0) scale(1)';
        });
      });

      // Add click ripple effect to buttons
      const buttons = document.querySelectorAll('.btn');
      buttons.forEach(button => {
        button.addEventListener('click', function(e) {
          const ripple = document.createElement('span');
          const rect = this.getBoundingClientRect();
          const size = Math.max(rect.width, rect.height);
          const x = e.clientX - rect.left - size / 2;
          const y = e.clientY - rect.top - size / 2;
          
          ripple.style.width = ripple.style.height = size + 'px';
          ripple.style.left = x + 'px';
          ripple.style.top = y + 'px';
          ripple.classList.add('ripple');
          
          this.appendChild(ripple);
          
          setTimeout(() => {
            ripple.remove();
          }, 600);
        });
      });
    });

    // Show loading spinner
    function showLoadingSpinner() {
      const spinner = document.getElementById('loadingSpinner');
      const overlay = document.getElementById('loadingOverlay');
      
      overlay.style.display = 'block';
      spinner.style.display = 'block';
      
      // Auto-hide after 10 seconds (failsafe)
      setTimeout(hideLoadingSpinner, 10000);
    }

    // Hide loading spinner
    function hideLoadingSpinner() {
      const spinner = document.getElementById('loadingSpinner');
      const overlay = document.getElementById('loadingOverlay');
      
      spinner.style.display = 'none';
      overlay.style.display = 'none';
    }

    // Hide spinner when page loads
    window.addEventListener('load', hideLoadingSpinner);

    // Smooth scroll for anchor links
    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
      anchor.addEventListener('click', function (e) {
        e.preventDefault();
        const target = document.querySelector(this.getAttribute('href'));
        if (target) {
          target.scrollIntoView({
            behavior: 'smooth',
            block: 'start'
          });
        }
      });
    });

    // Add CSS for ripple effect
    const style = document.createElement('style');
    style.textContent = `
      .btn {
        position: relative;
        overflow: hidden;
      }
      
      .ripple {
        position: absolute;
        border-radius: 50%;
        background: rgba(255, 255, 255, 0.6);
        transform: scale(0);
        animation: ripple-animation 0.6s linear;
        pointer-events: none;
      }
      
      @keyframes ripple-animation {
        to {
          transform: scale(4);
          opacity: 0;
        }
      }
      
      @keyframes slideOutRight {
        from {
          opacity: 1;
          transform: translateX(0);
        }
        to {
          opacity: 0;
          transform: translateX(100px);
        }
      }
    `;
    document.head.appendChild(style);
  </script>
  {% block scripts %}{% endblock %}
</body>
</html>